<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: map.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: map.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** base Map class
 * ctor 
 * initializes a new Map object
 * this class takes care of all Leaflet Map related functionality
 * @constructor
 * @field {Object} _globals global values related to the leaflet map
 * @field {Object} _layers object to store base and overlay layer arrays
 * @field {Object} _ids object to store map and sidebar HTML ids
 * @param {String} _map_id the id of the leaflet map container w/o project specific prefix
 * @param {String} sidebar_id the id of the map attached sidebar element
 * @param {String} id_prefix a project specific prefix for id elements
 */
function Map( map_id, sidebar_id, id_prefix )
{
    this._globals = { map: { MIN_ZOOM_WORLD:1, MAX_ZOOM_WORLD:19 } };
    this._layers = { base: [], overlay: [] };
    this._ids4js = {};
    
    this._add_id4js('prefix', id_prefix);
    var ids = new Ids( this._create_id(id_prefix, sidebar_id), this._create_id(id_prefix, map_id) );
    $.each(this._ids4js, function(k,v) {
        //console.log('adding',k, ' => ', v, 'to window.ids', window.ids);
        ids[k] = v;
    });
    
    /* store sidebar and map ids here
     * ids is an object of @class Ids
     */
    this._ids = ids.get(); //{ map: 'map', sidebar: 'sidebar' };
}

/** *** initializes a new Leaflet map object and layer control object ***
 * adds the sidebar to the Leaflet map
 * sidebar and map HTML ids are fetched from a window.ids object which is created by sidebar.php class ...
 * ... the Map class constructer fetches this object and assigns it to this._ids property
 * @param {Object} params a Leaflet parameter object, e.g. { center: [51.3, 13.37], zoom: 6} [optional]
 */
Map.prototype.init = function(params, suffix="")
{
    if (typeof params === 'undefined') { params = { center: [51.3, 13.37], zoom: 4 }; }
    this.base_maps = {};
    for (i = 0; i&lt;this._layers.base.length; ++i) {
        this.base_maps[this._layers.base[i].description()] = this._layers.base[i].layer();
    }
        
    /* private property
     * init map object with first layer selected 
     */
    this._map = L.map(this._ids.map + suffix, {
        center: params.center,
        zoom: params.zoom,
        layers: [this._layers.base[0].layer()]
    });
    
    /* private property
     * create the layers control 
     */
    this._layerControl = new L.control.layers(this.base_maps, null, { collapsed: true }).addTo(this._map);

    /* TODO - handle JsonLayer geojson not yet finished fetching when this function executes */
    for (i = 0; i&lt;this._layers.overlay.length; ++i) {
        if (! (this._layers.overlay[i].added() || typeof this._layers.overlay[i].layer() === 'undefined') ) {
            this._map_add_layer(this._layers.overlay[i]);
        }
    }
    
    /* add the sidebar to the map html container */
    this.sidebar();
};

/** *** ***
 * @returns this Leaflet map object
 */
Map.prototype.map = function()
{
    return this._map;
};

/** *** ***
 * @returns this Leaflet ids object
 */
Map.prototype.ids = function()
{
    return this._ids;
};

/** *** ***
 * @returns this Leaflet layercontrol object
 */
Map.prototype.layercontrol = function()
{
    return this._layerControl;
};


/** *** pushes a new @class BaseLayer object to the data structure ***
 * @param description the description of the layer as it is displayed in the map control widget
 * @param url the URL string of this layer
 * @param attribution the attribution string, e.g. layer reference
 */
Map.prototype.add_base_layer = function(description, url, attribution)
{
    this._layers.base.push( new BaseLayer(description, url, attribution) );
};

/** *** adds a new vector layer from a json file to the map ***
 * @param description the description of the layer as it is displayed in the map control widget
 * @param url the URL where json file is to be found
 * @param params a style parameter object [optional]
 */
Map.prototype.add_json_layer = function(description, url, params)
{
    var l = new JsonLayer(description, url, this._json_callback_fn.bind(this), params );
    //this._layers.overlay.push(l);
    //console.log('params', params, 'new json layer', l);
    return l;
};

/** *** adds a new vector layer from an ESRI shapefile file to the map ***
 * @param description the description of the layer as it is displayed in the map control widget
 * @param url the URL where the zipped shapefile file is to be found
 * @param params a style parameter object [optional]
 */

Map.prototype.add_shpzip_layer = function(description, url, params)
{
    var l = new ShpJsonLayer(description, url, this._json_callback_fn.bind(this), params );
    //this._layers.overlay.push(l);
    //console.log('params', params, 'new shp layer', l);
    return l;
};


/** *** returns the map object's overlay array ***
 * @return this map object's array of added vector overlays
 */
Map.prototype.overlays = function()
{
    return this._layers.overlay;
};

/** *** adds the sidebar to the map ***
 * requires the @https://github.com/Turbo87/sidebar-v2 Leaflet sidebar plugin
 * @param id the HTML id of the sidebar 
 */
Map.prototype.sidebar = function()
{
    this.sidebar = L.control.sidebar(this._ids.sidebar);
    /* make sure the sidebar isn'n covered by other html objects */
    $('#'+this._ids.sidebar).css( "zIndex", 1001 );
    $('.sidebar-content').css( "zIndex", 1001 );
    //this.sidebar.on('show', onSidebarShow);
    this.sidebar.addTo(this._map);
};

/** *** private ***
 * callback fn that gets called from an object of @class JsonLayer or one of it's child classes ...
 * ... once that object is done fetching the geojson layer object that it wraps
 * the response wrapped geojson object is added to the leaflet map from here
 * @param response a @class JsonLayer object 
 */
Map.prototype._json_callback_fn = function(response)
{
    console.log('callback', response, 'this', this);
    this._layers.overlay.push(response);
    this._map_add_layer(response);
};

/** *** private ***
 * adds a layer to the map and to the layer control
 * @param layerobj an object of @class JsonLayer or one of it's child classes
 * property layer the layer to add to the map and the layer control 
 * property description the layer's description in the layer control
 */
Map.prototype._map_add_layer = function(layerobj)
{
    /* test if this layer already has been added */
    if (!layerobj.added()) {
        /* if the leaflet map hasn't been created we cannot add stuff to it */
        if (typeof this._map === 'undefined') {
            // TODO - error handling
        } else {
            /* mark this layer as added */
            layerobj.added(true);
            /* add the layer to map and layer control */
            layerobj.layer().addTo(this._map);
            this._layerControl.addOverlay(layerobj.layer(), layerobj.description());
        }
    }
};




Map.prototype._add_id4js = function(key, value)
{
    this._ids4js[key] = value;
};

Map.prototype._create_id = function(id_prefix, id_postfix)
{
    return (id_prefix.length === 0)? id_postfix : id_prefix + '_' + id_postfix;
};


/** ----------------------------------------------------- **/

function Ids(s,m){this._i={map:m,sidebar:s};}
Ids.prototype.get=function(){return this._i;};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseLayer.html">BaseLayer</a></li><li><a href="JsonLayer.html">JsonLayer</a></li><li><a href="Layer.html">Layer</a></li><li><a href="LayerStyle.html">LayerStyle</a></li><li><a href="Legend.html">Legend</a></li><li><a href="Map.html">Map</a></li><li><a href="ShpJsonLayer.html">ShpJsonLayer</a></li><li><a href="Style.html">Style</a></li><li><a href="ZipFileReader.html">ZipFileReader</a></li></ul><h3>Mixins</h3><ul><li><a href="%257BJsonLayer%257D%2520multi%2520inherits%2520from%2520%257BLayer%257D%2520and%2520%257BLayerStyle%257D%2520%250Aso%2520it%2520copies%2520over%2520%257BLayerStyle%257D_s%2520protoype%2520members.html">{JsonLayer} multi inherits from {Layer} and {LayerStyle} 
so it copies over {LayerStyle}'s protoype members</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Data">Data</a></li><li><a href="global.html#DataDisplay">DataDisplay</a></li><li><a href="global.html#Gmpe">Gmpe</a></li><li><a href="global.html#Ids">Ids</a></li><li><a href="global.html#Instancestate">Instancestate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon May 29 2017 11:29:11 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
