{% extends 'base.html' %}

{% block head %}
	{% with fontawesome=False leaflet=False plotly=False %}
		{{ block.super }}
	{% endwith %}
{% endblock %}

{% block extra-head %}
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
<!-- includes css for form-related stuff (e.g. waitbar)  -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="{% static 'css/apidoc.css' %}">
{% endblock %}

{% block body %}
<div class='flexible d-flex flex-row'>
<div id='toc' class='px-4 pt-3' style='overflow:auto'>
</div>
<div class='flexible text-justify px-4 pt-3'>
<div class='content'>


<!--  NOTE FOR GENERATING THE PAGE WITH wkhtml...:
wkhtmltopdf --no-stop-slow-scripts --print-media-type -B 25 -T 25 -L 25 -R 25 --title "eGSIM API Documentation" http://127.0.0.1:8000/service/apidoc ~/Desktop/egsim.pdf
ISSUES: no javascript executed
 -->

<h1>eGSIM API</h1>
{% if last_modified %}
<p style='font-size:50%;text-align:right;'>Last modified: {{ last_modified }}</p>
{% endif %}

<p>
eGSIM is a web service for selecting and testing Ground
Shaking Intensity Models (GSIM) in Europe on top of  
<a target="_blank" href="https://github.com/GEMScienceTools/gmpe-smtk#gmpe-smtk">GMPE-SMTK</a>,
a Python and
<a target="_blank" href="https://github.com/gem/oq-engine/#openquake-engine">OpenQuake</a>-based
toolkit for analysis of strong Motions and interpretation of Ground Motion Prediciton Equations (GMPE).
As server-side web application programming interface (API), the goal
of eGSIM is to provide most of the toolkit functionalities via 
several publicly exposed endpoints (URLs) to a defined and easy to use requestâ€“response message
system.
</p>

<p class='footnote'>Note: throughout this document, for simplicity
the terms GSIM and GMPE are used interchangeably</p>

<h2 id="generalfeatures">General features</h2>
<p>
eGSIM is implemented along the lines of typical seismological web services (see e.g. the
<a target="_blank" href="https://www.fdsn.org/webservices/FDSN-WS-Specifications-1.1.pdf">FDSN protocol</a>):
<i>requests</i> can be issued by a client (eGSIM user) in several ways such as e.g. command line
applications like <code>wget</code> or inside client code with dedicated libraries
(e.g. Python's <code>urllib.request</code>). Requests require an endpoint, i.e. an URL denoting
a specific service, a method (GET vs POST) and usually parameters for tuning the functionality.
The web server processes the request and returns a <i>response</i> to the client in specific
formats described in the remainder of this document.
</p>


<h3 id="requestendpoints">Requests endpoints</h3> 
<p>
The following base URI pattern is to be used for each request:
</p>

<p>
<code class='pre'>{{ baseurl }}/&lt;service&gt;</code>
</p>

<p>
where <code>&lt;service&gt;</code> is one of the following:
</p>
<ul>
	<li><code>{{ gsimsel }}</code> for <a href="#gsimselection"> Gsim selection</a> </li>
	<li><code>{{ trellis }}</code> for generating <a href="#trellisplots"> Trellis plots data</a> </li>
	<li><code>{{ residuals }}</code> for <a href="#residualanalysis"> Residual analysis</a> </li>
	<li><code>{{ test }}</code> for <a href="#testing">Testing</a> </li>
</ul>


<h3 id="requestmethods">Requests methods</h3>
<p>
eGSIM services will be invoked using a subset of REST and HTTP methods. In particular all services
can be invoked using the HTTP GET or POST methods, the latter being more suitable for the 
cases where the selection parameters are potentially large in size (typically, POST request
are used to send data to create/update a resource on the server. Unless otherwise stated,
this is generally not the case here).
</p>

<h4>GET method</h4>
<p>
Requests issued with the GET method simply concatenate the parameters names and
values directly in the URL:
</p>

<p>
<code>{{ baseurl }}/&lt;service&gt;?<span class="token key atrule">name1</span>=<span class="token number">value1</span>&amp;<span class="token key atrule">name2</span>=<span class="token number">value2</span></code>
</p>

<p>
Where the portion of string after the question mark ? is called <i>query string</i>.
Parameter names can be provided multiple times in the query string. In case, the result
will be obtained by merging all matching values. Alternatively, the user can supply
comma-separated list of values to obtain the same effect.
Each parameter value might contain any alpha numeric character (a to z, A to Z, 0 to 9)
and the following characters (some of which might have
<a href='#requestparameters'>special meanings</a>): <code>{{ query_params_safe_chars }}</code>

<p class='footnote'>Note: The set of characters above currently covers most of the needs of
eGSIM users. Other characters should be 
<a href="https://en.wikipedia.org/wiki/Percent-encoding" target='_blank'>percent encoded</a>.
For Python users, see the function <a href='https://docs.python.org/3/library/urllib.parse.html#url-quoting'>quote</a>
and similar.
</p>

<h4>POST method</h4>
<p>
Requests issued with the POST method should use the usual URI pattern:
<code>{{ baseurl }}/&lt;service&gt;</code>
and provide the parameters set by means of additional data as text in
<a target="_blank" href="https://en.wikipedia.org/wiki/JSON#Data_types.2C_syntax_and_example">JSON</a> or
<a target="_blank" href="https://en.wikipedia.org/wiki/YAML#Example">YAML</a> format.
The way the POST request has to be built with its data is responsibility of the user
as it depends on the client software. For instance, this code snippet shows how to build a request using Python (see 
<a href='https://docs.python.org/3/howto/urllib2.html' target="_blank">HOWTO Fetch Internet Resources Using The urllib Package</a> for details):
</p>

<pre><code class="language-python">import json
import yaml  # needs PyYAML installed
# imports for Python3  (comment/remove in Python2):
from urllib.request import Request, urlopen
from urllib.error import URLError, HTTPError
# imports for Python2 (comment/remove in Python3):
from urllib2 import Request, urlopen, URLError, HTTPError

# 1) Request using the GET method:
req = Request("eGSIM endpoint URL with encoded special characters, if any")

# 2a) Request using the POST method, assuming JSON text file:
with open('/path/to/my/file.json', 'r') as stream:
    jsondata = json.load(f)
req = Request("write here your eGSIM endpoint URL", data=jsondata)

# 2b) Request using the POST method, assuming YAML or JSON text file
#     (YAML is a superset of JSON and thus this works also with JSON files):
with open('/path/to/my/file.yaml', 'r') as stream:
    yamldata = yaml.safe_load(stream))
req = Request("write here your eGSIM endpoint URL", data=yamldata)</code></pre>



<h3 id="requestparameters">Request parameters</h3>

<p>
Request parameters can be input in three ways: in the URL of a GET request, in a YAML- or
JSON-formatted text file in case of POST request, or via input components of the
web Graphical User Interface (GUI) thorugh a web browser.
eGSIM supports the following parameter types:
</p>


<ul>
<li>numeric
<li>string
<li>boolean
<li>UTC date-time (in ISO format without timezone, e.g.:
<code>2016-01-30T23:15:11</code> or <code>2016-01-31</code>)
<li>arrays (vectors) of the previous types
<li>numeric ranges (i.e., equally spaced numeric arrays) in the
<a href="https://www.mathworks.com/help/matlab/ref/colon.html#bvhfyce" target="_blank">MATLAB<sup>&reg;</sup> format</a>
<code>start:step:end</code>
(e.g. <code>0:0.1:0.3</code> results in the sequence of values 0, 0.1, 0.2, 0.3)
</ul>

<p>
For POST requests, most types are supported in YAML and JSON <i>except</i> numeric ranges, which must be
input as strings with quotes (e.g. <code>"0:0.1:0.3"</code>).
JSON does <b>not</b> support also date-times, which thus need 
to be input in the same way, e.g.: <code>"2016-01-31T23:15:00"</code> (in YAML, date-times as quoted
strings are permitted but not mandatory).
</p>

<p>
For GET request URLs, aside colons (:) for numeric ranges,
<b>commas (,)</b> act as element separators in array strings. The user can also supply the same
parameter name multiple times with different values. Besides alpha-numeric characters,
always safe, remember to percent-encode all characters 
non  not in <code>{{ query_params_safe_chars }}</code>. 
In any case, no parameter value needs to be quoted.
</p>

<p>
From within an input component of the Web GUI, aside colons (:) for numeric ranges,
<b>commas (,) or spaces</b> act as element separators in array string. Arrays can be input 
with or without leading and trailing square brackets '[' ']'.
In both cases, no parameter value needs to be quoted.
</p>

<p>
 For instance, assuming a general <code>example</code> service requiring
three numeric parameters (dip, scalar, Vs<sub>30</sub>, array and ranges of
magnitudes) the user input, depending on the request's method, should look like:
</p>

<table class='nopagebreak'>
<tr>
	<td>GET</td>
	<td colspan="2"><code>{{ baseurl }}/example?dip=45&vs30=560,760&magnitude=3:0.5:5</code></td>
</tr>
<tr>
	<td rowspan="3">POST</td>
	<td colspan="2">
		<code>{{ baseurl }}/example</code>
	</td>
</tr>
<tr>
	<td style='border-color:transparent'>data (YAML file)</td><td style='border-color:transparent'>data (JSON file)</td>
</tr>
<tr>
	<td><pre><code class="language-yaml">dip: 45
vs30:
 - 560
 - 760
magnitude: "3:0.5:5"
</code></pre></td>
	<td><pre><code class="language-json">{
  "dip": 45, 
  "vs30": [560, 760],
  "magnitude": "3:0.5:5"
}</code></pre></td>
</tr>
<tr>
	<td>Web GUI components</td>
	<td colspan="2">
		<div style='white-space: nowrap'>
			<span class='mr-1'>Dip</span>
			<input type="number" value="45"/>
			<span class='ml-2 mr-1'>Vs<sub>30</sub></span>
			<input type="text" value="560 760"/>
			<span class='ml-2 mr-1'>Magnitude</span>
			<input type="text" value="3:0.5:5"/>
		</div>
	</td>
</table>

<p>
The full description of the parameters and their constraints will be given in each service specific
section below.
</p>


<h3 id="responsedata">Response data</h3>
<p>
The response data type of a successfully fullfilled request might depend on the service used and
the parameter issued in the request, but all eGSIM services can return data at the least in CSV
and JSON formatted text (bytes sequences). 
JSON is by far preferable in web applications
(the eGSIM web GUI for instances requests and processes data in this format), and CSV files have
the advantage to be easily visualizable in widely used spreadsheet softwares.
However, for client code processing response data, both formats
are widely supported in most languages (see e.g., the MATLAB<sup>&reg;</sup>
<a href="https://www.mathworks.com/help/matlab/ref/jsondecode.html" target="_blank">jsonencode</a> and 
<a href="https://www.mathworks.com/help/matlab/ref/csvread.html" target="_blank">csvread</a>
functions, or Python 
<a href="https://docs.python.org/3/library/json.html" target="_blank">json</a> and 
<a href="https://docs.python.org/3/library/csv.html" target="_blank">csv</a>
standard libraries)
</p>


<p>
Unsuccessful requests might fail for several reasons. In case of client
or server errors, such as e.g. bad or missing parameters, eGSIM always returns responses
in JSON formatted byte strings following the <a href="https://google.github.io/styleguide/jsoncstyleguide.xml#Reserved_Property_Names_in_the_error_object" target="_blank">
google API specification</a>. Example:
</p>

<pre><code class="language-json">{
	"error": {
		"code": 400,
		"message": "input validation error",
		"errors": [
			{
		    	"domain": "magnitude",
		    	"message": "This field is required.",
		    	"reason": "required"
		  	},
		  ...
		]
	}
}</code></pre>

<p class='footnote'>
Notes: the code and the message are standard HTTP numeric status codes &ge;400 and &le; 500 and
text. For invalid parameters, the code is 400. In this case the the parameter 'errors' might
be provided (in all other cases it's missing), and it is a list of objects with these
properties: domain (indicating the parameter name raising the error), message
(indicating the error message) and reason (indicatin th error reason).
</p>

<p>
For instance, this code snippet modified from the
<a href="https://docs.python.org/3/howto/urllib2.html" target="_blank">standard Python how-to reference</a>
shows how to issue a request to a eGSIM service and catch potential errors in both Python2 and 3
(tested with Python 2.7 and 3.6):
</p>

<pre><code class="language-python">import json

# imports for Python3  (comment/remove in Python2):
from urllib.request import Request, urlopen
from urllib.error import URLError, HTTPError

# imports for Python2 (comment/remove in Python3):
from urllib2 import Request, urlopen, URLError, HTTPError

req = Request("write here your eGSIM endpoint URL")
try:
    data = json.loads(urlopen(req))
except HTTPError as e2:
    # handle HTTP errors because of a server or client error, e.g.:
    print("Http error %d" % e2.code)
    # If you want to dig into details,
    # load the JSON formatted response into a Python dict:
    errordict = json.loads(e2.read())['error']
    # now you can access fields such as
    # errordict['message'], errordict.get('errors', [])
except URLError as e1:
    # handle general url errors like network errors. e.g.:
    print("Url error. Reason: %s" % e1.reason)
</code></pre>


<h2 id="gsimselection">Gsim selection</h2>
<p><b>Endpoint: <code>{{ baseurl }}/{{ gsimsel }}</code></b></p>
<p>
This simple service pefrorms a GMPE selection based on several filtering parameter,
including matching tectonic regions defined in specified Area source (or Tectonic region) models.
</p>

<h3>Request</h3>
<p>
A request to the GSIM selection service does not require any mandatory parameter: in case, all
OpenQuake's available GMPEs will be returned. This rather trivial search is usually refined
by specifying the desired GMPE names, IMTs or tectonic
region types (TRT): all parameter values (strings) may include specific wildcard characters 
with special meanings (see <a href="https://docs.python.org/3/library/fnmatch.html" target='_blank'>here</a>
for details). In case of IMTs and TRTs, the GMPEs defined for any of the selected
intensity measure types and tectonic regions will be returned.
The search can be refined by specifying a tectonic region model (currently implemented
is only <a href="http://www.efehr.org/en/Documentation/specific-hazard-models/europe/seismogenic-sources/"
target='_blank'>SHARE</a>) and a location on earth (or a rectangular region): in this case,
the TRTs will be further filtered based on the model's tectonic regions including that point
(or intersecting the rectangle).
eGSIM currently does not exploit any model-defined mapping between TRTs and GMPEs, but simply
utilizes the tectonic regions defined on each GMPE in OpenQuake.

As discussed, parameters can be given in the endpoint URL (GET method) or as
separate text data in JSON or YAML format (POST method) and are:
</p>

{{ form_gsims | safe }}

<h3>Response</h3>
<p>
The list of selected GMPEs will be returned as JSON-formatted array of strings or as CSV. In the
latter case, the user can choose the orientation (vertical vs. horizontal) for e.g.,
better visualization.
</p>



<h2 id="trellisplots">Trellis plots</h2>
<p><b>Endpoint: <code>{{ baseurl }}/{{ trellis }}</code></b></p>
<p>
Trellis plots provide an understanding of the manner in which each GMPE characterises the ground
motion scaling with respect to the properties of the seismic source, and the attenuation of the
motion with respect to distance. By means of the
underlying GMPE-SMTK library, eGSIM can generate different plot types:
<ul>
<li> IMT vs Magnitude plots show how the ground motion intensity value scales with
respect to the magnitude of the rupture.
<li> IMT vs Distance plots allow to compare how the GMPEs describe the attenuation of strong
motion with distance for a given magnitude. 
<li> Magnitude-Distance spectra let the user understand how a
GMPE will scale the response spectrum with magnitude and distance.
</ul>
<p>
In addition to viewing the scaling of the expected ground motion from the GMPE,
it is also possible to view the scaling of the standard deviation, for a total of six
choosable plot types.
</p>

<h3>Request</h3>
<p>
A request to the Trellis plot service requires a list of GMPEs and IMTs,
the desired plot type and the parameters configuring the scenario (rupture), most of which are
optional. As discussed, parameters can be given in the endpoint URL (GET method) or as
separate text data in JSON or YAML format (POST method) and are:
</p>

{{ form_trellis | safe }}

<h3>Response</h3>
<p>
The number of generated Trellis plots depends on the requested Intensity measure types (parameter
{{ param.trellisform.imt.name }}) <i>and</i> the parameters {{ param.trellisform.magnitude.name }},
{{ param.trellisform.distance.name }} and
{{ param.trellisform.vs30.name }} (which can be given as numeric scalr or array):
</p>

<table class='nopagebreak'>
<thead>
<tr>
	<td>Plot type</td>
	<td>Parameter setting the x values (should be numeric array):</td>
	<td>The number of generated plots is the product of all supplied values of:</td></tr>
</thead>
<tbody>
<tr>
	<td>{{ param.trellisform.plot_type.choices.0.label }}</td>
	<td>{{ param.trellisform.distance.name }}</td>
	<td>{{ param.trellisform.imt.name }}, {{ param.trellisform.magnitude.name }}, {{ param.trellisform.vs30.name }}</td>
</tr>
<tr>
	<td>{{ param.trellisform.plot_type.choices.1.label }}</td>
	<td>{{ param.trellisform.magnitude.name }}</td>
	<td>{{ param.trellisform.imt.name }}, {{ param.trellisform.distance.name }}, {{ param.trellisform.vs30.name }}</td>
</tr>
<tr>
	<td>{{ param.trellisform.plot_type.choices.2.label }}</td>
	<td>None: a set of pre-defined periods will be used</td>
	<td>{{ param.trellisform.imt.name }}, {{ param.trellisform.magnitude.name }}, {{ param.trellisform.distance.name }}, {{ param.trellisform.vs30.name }}</td>
</tbody>
</table>

<h4>JSON</h4>
<p>
Trellis plot data returned in JSON format will have the following structure:
</p>
<pre><code class="language-json">{
	"xvalues": [2.905, 3.771, ... ],
	"xlabel": "Rupture Dist. (km)",
	"figures": {
			"PGA": {
				"yvalues":{
					"AkkarEtAl2013": [0.3811, 0.3812, ...],
					"CauzziEtAl2014": [0.283, 0.283, ...],
					...
				},
				"ylabel": "Median PGA (g)",
				"magnitude": 5,
				"distance": null,
				"vs30": 760
			},
			"PGV": {
				...
			},
			...
		},
		...
	}
}</code></pre>
<p class='footnote'>
Notes: All plots share the same x axis and x values, thus for performance reasons
those veriables are not repeated inside each nested object. Magnitude and distance
attributes of each nested object are null for those plot type using them as x axis values
and not as iteration parameter to generate several plots. 
</p>


<h4 style='page-break-before: always !important;'>CSV</h4>
<p>
Trellis plot data returned in CSV format will have the following structure.
<br>
<span class='xvalues'></span> = x values (first cell is the x label), 
<span class='yvalues'></span> = y values (first cell is the y label)
</p>


<h5>Vertical display (&varr;)</h5>

<table class='csv'>
<tr>
	<td>&nbsp;</td>
	<td>AkkarEtAl2013</td>
	<td>AkkarEtAl2013</td>
	<td>&hellip;</td>
	<td>CauzziEtAl2014</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>&nbsp;</td>
	<td>PGA</td>
	<td>PGA</td>
	<td>&hellip;</td>
	<td>PGA</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>magnitude:</td>
	<td>5</td>
	<td>5.5</td>
	<td>&hellip;</td>
	<td>5</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>distance:</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>vs30:</td>
	<td>760</td>
	<td>760</td>
	<td>&hellip;</td>
	<td>760</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td class='xvalues'>Rupture Dist. (km)</td>
	<td class='yvalues'>Median PGA (g)</td>
	<td class='yvalues'>Median PGA (g)</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>Median PGA (g)</td>
	<td class='yvalues'>&hellip;</td>
</tr>
<tr>
	<td class='xvalues'>2.905</td>
	<td class='yvalues'>0.3811</td>
	<td class='yvalues'>0.283</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>0.21</td>
	<td class='yvalues'>&hellip;</td>
</tr>
<tr>
	<td class='xvalues'>3.771</td>
	<td class='yvalues'>0.3812</td>
	<td class='yvalues'>0.283</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>0.291</td>
	<td class='yvalues'>&hellip;</td>
</tr>
<tr>
	<td class='xvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
</tr>
</table>


<h5>Horizontal display (&harr;)</h5>

<table class='csv'>
<tr>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td class='xvalues'>Rupture Dist. (km)</td>
	<td class='xvalues'>2.905</td>
	<td class='xvalues'>3.771</td>
	<td class='xvalues'>&hellip;</td>
</tr>
<tr>
	<td>AkkarEtAl2013</td>
	<td>PGA</td>
	<td>magnitude:</td>
	<td>5</td>
	<td>distance:</td>
	<td></td>
	<td>vs30:</td>
	<td>760</td>
	<td class='yvalues'>Median PGA (g)</td>
	<td class='yvalues'>0.3811</td>
	<td class='yvalues'>0.3812</td>
	<td class='yvalues'>&hellip;</td>
</tr>
<tr>
	<td>AkkarEtAl2013</td>
	<td>PGA</td>
	<td>magnitude:</td>
	<td>5.5</td>
	<td>distance:</td>
	<td></td>
	<td>vs30:</td>
	<td>760</td>
	<td class='yvalues'>Median PGA (g)</td>
	<td class='yvalues'>0.283</td>
	<td class='yvalues'>0.283</td>
	<td class='yvalues'>&hellip;</td>
</tr>
<tr>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
</tr>
<tr>
	<td>CauzziEtAl2014</td>
	<td>PGA</td>
	<td>magnitude:</td>
	<td>5</td>
	<td>distance:</td>
	<td></td>
	<td>vs30:</td>
	<td>760</td>
	<td class='yvalues'>Median PGA (g)</td>
	<td class='yvalues'>0.21</td>
	<td class='yvalues'>0.291</td>
	<td class='yvalues'>&hellip;</td>
</tr>
</table>


<h2 id="residualanalysis">Residual analysis</h2>
<p><b>Endpoint: <code>{{ baseurl }}/{{ residuals }}</code></b></p>
<p>
eGSIM, through the GMPE-SMTK library, offers the ability to compare observed ground motions with
the GMPE model predictions using the GMPE implementations found inside OpenQuake.
This is a particularly powerful tool as it permits a
hazard modeller to undertake the GMPE comparison using the exact same GMPE implementation
found inside the seismic hazard software. All analyses undertaken will, by default,
analyse the total residual, the inter-event residual and the intra-event residual, exposed to the
user via Residuals plots.
</p>

<h3>Request</h3>
<p>
A request to the Residuals plot service requires a list of GMPEs and IMTs, a Ground Motion
database (GMDB) and the the desired plot type. As discussed, parameters can be given in the endpoint
URL (GET method) or as separate text data in JSON or YAML format (POST method) and are:
</p>

{{ form_residuals | safe }}

<h3>Response</h3>
<p>
The number of generated Residuals plots will be the product of the requested Intensity
measure types (parameter {{ param.residualsform.imt.name }}) and the requested GMPEs
(parameter {{ param.residualsform.gsim.name }}. Each Residual plot is futher subdivided
into three subplots:
</p>

<table class='nopagebreak'>
<thead>
<tr>
	<td>Plot type</td>
	<td>Residual plots per (GMPE, IMT) tuple</td>
	<td>Plot description</td>
	<td>Additional plot attributes</td>
</thead>
<tbody class='grid'>
<tr>
	<td>{{ param.residualsform.plot_type.choices.0.label }}</td>
	<td rowspan="7">'Intra Event', 'Inter Event' and 'Total'</td>
	<td>Histogram of frequencies (y axis) vs residuals bins (x)</td>
	<td>Mean, standard deviation of the distribution</td>
</tr>
<tr>
	<td>{{ param.residualsform.plot_type.choices.1.label}}</td>
	<td>Histogram of the frequencies (y) vs residuals likelihood bins (x)</td>
	<td>Median of the distribution</td>
</tr>
<tr>
	<td>{{ param.residualsform.plot_type.choices.2.label}}</td>
	<td>Scatter plot of residuals (y) vs. magnitude (x)</td>
	<td rowspan="5">p-value and linear regression (slope, intercept)</td>
</tr>
<tr>
	<td>{{ param.residualsform.plot_type.choices.3.label}}</td>
	<td>Same as above with distance as point's x</td>
</tr>
<tr>
	<td>{{ param.residualsform.plot_type.choices.4.label}}</td>
	<td>Same as above with Vs<sub>30</sub> as point's x</td>
</tr>
<tr>
	<td>{{ param.residualsform.plot_type.choices.5.label}}</td>
	<td>Same as above with depth as point's x</td>
</tr>
<tr>
	<td>{{ param.residualsform.plot_type.choices.6.label}}</td>
	<td>Same as above with stations as point's x</td>
</tr>
<tr>
	<td>{{ param.residualsform.plot_type.choices.7.label}}</td>
	<td style='width:18em'>'Intra Event' (not normalised by the intra-event standard deviation),
	'Average within-event' (Average within-event residual for each station),
	'Variabilities distribution' (the distribution residual variabilities for each station)</td>
	<td>Scatter plots of the plot residuals (y axis) vs. each station (x)</td>
	<td>mean and standard deviation</td>
</tr>
</tbody>
</table>


<h4>JSON</h4>
<p>
Residuals plot data returned in JSON format will have the following structure:
</p>
<pre><code class="language-json">{
	"AkkarEtAl2013": {
		"PGA": {
			"Intra Event": {
				"xvalues": [4, 4, 3.9, ...],
				"xlabel": "Magnitude",
				"yvalues": [-2.11, -2.27, -2.08, ...],
				"ylabel": "Z (PGA)",
				"slope": 0.269,
				"intercept": -1.998,
				"pvalue": 6.6e-8,
				"median": null,
				"mean": null,
				"stdev": null
			}
		},
		"PGV": {
			...
		},
		...
	},
	"CauzziEtAl2014": {
		...
	},
	...
}</code></pre>
<p class='footnote'>
Notes: the parameters from slope, intercept, pvalue, median, stdev are null for specific
plot types
</p>

<h4>CSV</h4>
<p>
Residuals plot data returned in CSV format will have the following structure (represented as
csv table).
<br>
<span class='xvalues'></span> = x values (first cell is the x label), 
<span class='yvalues'></span> = y values (first cell is the y label)
</p>

<h5>Vertical display (&varr;)</h5>

<table class='csv'>
<tr>
	<td>AkkarEtAl2013</td>
	<td>&nbsp;</td>
	<td>AkkarEtAl2013</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
	<td>AkkarEtAl2013</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
	<td>CauzziEtAl2014</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>PGA</td>
	<td>&nbsp;</td>
	<td>PGA</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
	<td>PGV</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
	<td>PGA</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>slope:</td>
	<td>0.269</td>
	<td>slope:</td>
	<td>0.103</td>
	<td>&hellip;</td>
	<td>slope:</td>
	<td>0.171</td>
	<td>&hellip;</td>
	<td>slope:</td>
	<td>0.28</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>intercept:</td>
	<td>-1.998</td>
	<td>intercept:</td>
	<td>-1.281</td>
	<td>&hellip;</td>
	<td>intercept:</td>
	<td>-2.12</td>
	<td>&hellip;</td>
	<td>intercept:</td>
	<td>-2.281</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>pvalue:</td>	
	<td>6.6e-8</td>
	<td>pvalue:</td>	
	<td>0.163</td>
	<td>&hellip;</td>
	<td>pvalue:</td>	
	<td>0.002</td>
	<td>&hellip;</td>
	<td>pvalue:</td>	
	<td>1.21e-8</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>Intra Event</td>
	<td>&nbsp;</td>
	<td>Inter Event</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
	<td>Intra Event</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
	<td>Intra Event</td>
	<td>&nbsp;</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td class='xvalues'>Magnitude</td>
	<td class='yvalues'>Z (PGA)</td>	
	<td class='xvalues'>Magnitude</td>
	<td class='yvalues'>Z (PGA)</td>	
	<td>&hellip;</td>	
	<td class='xvalues'>Magnitude</td>
	<td class='yvalues'>Z (PGV)</td>	
	<td>&hellip;</td>
	<td class='xvalues'>Magnitude</td>
	<td class='yvalues'>Z (PGA)</td>	
	<td>&hellip;</td>
</tr>
<tr>
	<td class='xvalues'>4</td>
	<td class='yvalues'>-2.11</td>	
	<td class='xvalues'>4</td>
	<td class='yvalues'>-1.832</td>	
	<td>&hellip;</td>
	<td class='xvalues'>4</td>
	<td class='yvalues'>-0.17</td>	
	<td>&hellip;</td>
	<td class='xvalues'>4</td>
	<td class='yvalues'>-1.116</td>	
	<td>&hellip;</td>
</tr>
<tr>
	<td class='xvalues'>4</td>
	<td class='yvalues'>-2.27</td>	
	<td class='xvalues'>4</td>
	<td class='yvalues'>-1.913</td>	
	<td>&hellip;</td>
	<td class='xvalues'>4</td>
	<td class='yvalues'>-1.11</td>	
	<td>&hellip;</td>
	<td class='xvalues'>4</td>
	<td class='yvalues'>-2.815</td>	
	<td>&hellip;</td>
</tr>
<tr>
	<td class='xvalues'>3.9</td>
	<td class='yvalues'>-2.08</td>	
	<td class='xvalues'>3.9</td>
	<td class='yvalues'>-1.85</td>	
	<td>&hellip;</td>
	<td class='xvalues'>3.9</td>
	<td class='yvalues'>-0.871</td>	
	<td>&hellip;</td>
	<td class='xvalues'>3.9</td>
	<td class='yvalues'>-2.11</td>	
	<td>&hellip;</td>
</tr>
<tr>
	<td class='xvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td class='xvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td>&hellip;</td>
	<td class='xvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td>&hellip;</td>
	<td class='xvalues'>&hellip;</td>
	<td class='yvalues'>&hellip;</td>
	<td>&hellip;</td>
</tr>
</table>


<h5>Horizontal display (&harr;)</h5>

<table class='csv'>
<tr>
	<td>AkkarEtAl2013</td>
	<td>PGA</td>
	<td>slope:</td>
	<td>0.269</td>
	<td>intercept:</td>
	<td>-1.998</td>
	<td>pvalue:</td>
	<td>6.6e-8</td>
	<td>Intra Event</td>
	<td class='xvalues'>Magnitude</td>
	<td class='xvalues'>4</td>
	<td class='xvalues'>4</td>
	<td class='xvalues'>3.9</td>
	<td class='xvalues'>&hellip;</td>
</tr>
<tr>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td class='yvalues'>Z (PGA)</td>
	<td class='yvalues'>-2.11</td>
	<td class='yvalues'>-2.27</td>
	<td class='yvalues'>-2.08</td>
	<td class='yvalues'>&hellip;</td>
</tr>
<tr>
	<td>AkkarEtAl2013</td>
	<td>PGA</td>
	<td>slope:</td>
	<td>0.103</td>
	<td>intercept:</td>
	<td>-1.281</td>
	<td>pvalue:</td>
	<td>0.163</td>
	<td>Inter Event</td>
	<td class='xvalues'>Magnitude</td>
	<td class='xvalues'>4</td>
	<td class='xvalues'>4</td>
	<td class='xvalues'>3.9</td>
	<td class='xvalues'>&hellip;</td>
</tr>
<tr>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td class='yvalues'>Z (PGA)</td>
	<td class='yvalues'>-1.832</td>
	<td class='yvalues'>-1.913</td>
	<td class='yvalues'>-1.85</td>
	<td class='yvalues'>&hellip;</td>
</tr>
<tr>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>AkkarEtAl2013</td>
	<td>PGV</td>
	<td>slope:</td>
	<td>0.171</td>
	<td>intercept:</td>
	<td>-2.12</td>
	<td>pvalue:</td>
	<td>0.002</td>
	<td>Intra Event</td>
	<td class='xvalues'>Magnitude</td>
	<td class='xvalues'>4</td>
	<td class='xvalues'>4</td>
	<td class='xvalues'>3.9</td>
	<td class='xvalues'>&hellip;</td>
</tr>
<tr>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td class='yvalues'>Z (PGV)</td>
	<td class='yvalues'>-0.17</td>
	<td class='yvalues'>-1.11</td>
	<td class='yvalues'>-0.871</td>
	<td class='yvalues'>&hellip;</td>
</tr>
<tr>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
	<td>&hellip;</td>
</tr>
<tr>
	<td>CauzziEtAl2014</td>
	<td>PGA</td>
	<td>slope:</td>
	<td>0.28</td>
	<td>intercept:</td>
	<td>-2.281</td>
	<td>pvalue:</td>
	<td>1.21e-8</td>
	<td>Intra Event</td>
	<td class='xvalues'>Magnitude</td>
	<td class='xvalues'>4</td>
	<td class='xvalues'>4</td>
	<td class='xvalues'>3.9</td>
	<td class='xvalues'>&hellip;</td>
</tr>
<tr>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td>&nbsp;</td>
	<td class='yvalues'>Z (PGA)</td>
	<td class='yvalues'>-1.116</td>
	<td class='yvalues'>-2.815</td>
	<td class='yvalues'>-2.11</td>
	<td class='yvalues'>&hellip;</td>
</tr>
</table>



<h2 id="testing">Testing</h2>
<p><b>Endpoint: <code>{{ baseurl }}/{{ test }}</code></b></p>
<p>

</p>

</div>	
</div>
</div>
{% endblock %}

{% block after-body %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/data-uri-highlight/prism-data-uri-highlight.min.js"></script>

<script type='text/javascript'>

/**
 * Sets up headings (h2 and h3) numbering and the corresponding
 * items in the div#toc
 */
function setupH(h, secIndex, subsecIndex){
    var id = h.getAttribute('id');
    if (!id){
        var id_ = id = h.innerText.replace(/ /g, '').toLowerCase();
  		var counter = 2;
        while (document.getElementById(id)){
            id = id_ + counter;
            counter++;
        }
        h.setAttribute('id', id);
    }
    h.setAttribute('name', id);
    var strNumber = `${secIndex}`;
    if (subsecIndex){
    	strNumber += `.${subsecIndex}`;
    }
    var text = h.innerHTML;
	var newText = `${secIndex}.${subsecIndex ? subsecIndex : ''} ${text} <a style='display:none' class="headerlink" href="#${id}" title="Permalink to this headline">&#182;</a>`;
	h.innerHTML = newText;
	// add mouseenter mouseleave. Note mouseout! see here:
	// https://javascript.info/mousemove-mouseover-mouseout-mouseenter-mouseleave#extra-mouseout-when-leaving-for-a-child
	h.onmouseenter = mouseevent => {
	    var target = mouseevent.target;
	    target.children[target.childElementCount-1].style.display = '';
	};
	h.onmouseleave = mouseevent => {
	    var target = mouseevent.target;
	    target.children[target.childElementCount-1].style.display = 'none';
	};
	return `${secIndex}.${subsecIndex ? subsecIndex : ''} ${text}`;
}
var [secIndex, subsecIndex] = [0, 0];
var tocItemsHTML = [];

document.querySelectorAll('h2, h3').forEach((elm, index) => {
    var tag = elm.tagName.toLowerCase();
    if (tag == 'h2'){
        secIndex ++;
        subsecIndex = 0;
    }else{
        subsecIndex ++;
    }
    var text = setupH(elm, secIndex, subsecIndex);
    tocItemsHTML.push(`${subsecIndex ? '&nbsp;'.repeat(4) : ''} <a href="#${elm.getAttribute('id')}">${text}</a>`); 
});
document.querySelector('#toc').innerHTML = `<div>${tocItemsHTML.join('</div><div>')}</div>`;

</script>

{% endblock %}
