{% extends 'base_vue.html' %}

{% block head %}
	{% with plotly=True axios=True %}
		{{ block.super }}
	{% endwith %}
	<link rel="stylesheet" type="text/css" href="{% static 'css/trellis.css' %}">
{% endblock %}
	
{% block main %}

	<div id='egsim-input'
		class='position-absolute pos-0 m-0 flex-direction-row justify-content-center'> <!-- p-3: padding=1rem -->
	
		<trellisform id='egsim-form' name='egsim-form' url='get_trellis_plots'
			submit_element_id='{{ form.plot_type.auto_id }}'
			v-on:submit="post"
            v-on:error="setError"
			class='flex-direction-col m-3 p-2'>

			<div class='flexible flex-direction-col'>

				<div class='flexible flex-direction-row'>

					<div id='inputsel' class="flexible flex-direction-col p-2">
						
						<gsims class='flexible'
							name="{{ form.gsim.html_name }}"
							id="{{ form.gsim.auto_id }}"
							label="{{ form.gsim.label }}"
							showfilter
							v-bind:errormsg="fielderrors['{{ form.gsim.html_name }}']"
							v-bind:avalgsims="avalGsims"
							v-bind:selectedgsims="selectedGsims"
							v-bind:selectedgsims.sync="selectedGsims">
						</gsims>
						
						<imts
							name="{{ form.imt.html_name }}"
							id="{{ form.imt.auto_id }}"
							label="{{ form.imt.label }}"
							v-bind:errormsg="fielderrors['{{ form.imt.html_name }}']"
							v-bind:avalgsims="avalGsims"
							v-bind:selectedgsims="selectedGsims"
							v-bind:avalimts="avalImts"
							v-bind:selectedimts="selectedImts"
							v-bind:selectedimts.sync="selectedImts">
						</imts>

					</div>
					
					<div id='rupture' class='flexible p-2'>
						{% for field in form.visible_fields %}
							{% if field.html_name != form.plot_type.html_name %}
							<div class="mr-2">{{ field.html_name }}
								<errorspan v-bind:errormsg="fielderrors['{{ field.html_name }}']"></errorspan>
							</div> <div>{{ field }}</div>
							<div class="text-muted small text-nowrap mb-2 field-help">
							{% if field.html_name|lower != field.label|lower %}
								{{ field.label }}{% if field.help_text %}: {% endif %}
							{% endif %}
							{{ field.help_text }}
							</div>
							{% endif %}
						{% endfor %}

					</div>

				</div>

				<div class='p-2 flex-direction-row'>
					<!-- the submit button is the plot_type field. See Vuw component where we attach the submit
					functionality -->
					<div>
						{{ form.plot_type.label }}
					</div>
					<div class=flexible>
						{{ form.plot_type }}
					</div>
				</div>

			</div>

		</trellisform>

	</div>

<!-- 	<div id='trellis' v-show='initialized' class='flexible flex-direction-row trellis-container pl-2'>
	
		<div class='flexible' style='position:relative'>
			<div class='trellis-plots-container' id='trellis-plots-container'></div>
		</div>
	
		<div class='trellis-right-panel flex-direction-col pl-3 pr-2'>
			<div>
				<button onclick='EGSIM_INPUT.dom.visible=!EGSIM_INPUT.dom.visible'>params</button>
			</div>
			<div class='flexible'>
				<div v-for="(value, key) in plotTraceColors">
					<label v-bind:style="{color: value}">
					<input type='checkbox' v-bind:checked="isTraceVisible(key)" v-on:click="toggleTraceVisibility(key)">
					&#123;&#123; key &#125;&#125;</label>
				</div>
			</div>
			<div>
				<div v-for='(values, key) in selectableParams'>
					<div>&#123;&#123; key &#125;&#125;:</div>
					<select v-model="selectedParams[key]">
						<option v-for='value in params[key]'>
							&#123;&#123; value &#125;&#125;
						</option>
					</select>
				</div>
			</div>
			<div>
				<div>Group vertically by:</div>
				<select v-model='gridyparam'>
					<option v-for='key in groupableParams' v-bind:value="key">
						&#123;&#123; key == 'ylabel' ? 'imt' : key &#125;&#125;
					</option>
				</select>
			</div>
			<div>
				<div>Group horizontally by:</div>
				<select v-model='gridxparam'>
					<option v-for='key in groupableParams' v-bind:value="key">
						&#123;&#123; key == 'ylabel' ? 'imt' : key &#125;&#125;
					</option>
				</select>
			</div>
		</div>
	 
	</div> -->
{% endblock %}


{% block after-body %}

<script type='text/javascript' src = "{% static 'js/components/errorspan.js' %}"></script>
<script type='text/javascript' src = "{% static 'js/components/gsims.js' %}"></script>
<script type='text/javascript' src = "{% static 'js/components/imts.js' %}"></script>
<script type='text/javascript' src = "{% static 'js/components/egsimform.js' %}"></script>
<script type='text/javascript' src = "{% static 'js/components/trellisform.js' %}"></script>

{{ block.super }}
<!-- script for configuring vue instance:
<script type='text/javascript' src = "{% static 'js/form-configs/trellis.js' %}"></script>
--> 

<!-- script for setting up our plot_type field: add first <option> as non-selectable 'label' option,
and make the <select> submit the form onChange: -->
<script type='text/javascript'>
(function setupSubmit(){
    return;
    // get our plot_type select element just rendered
    var submitSelect = document.getElementById("id_{{ form.plot_type.html_name }}"); // https://docs.djangoproject.com/en/1.9/topics/forms/#form-rendering-options
    // create a first option acting as "label", use the django label for that:
    var option = document.createElement("option");
    option.text = "{{ form.plot_type.label }}:";
    var no_value = '';
    option.value = no_value;
    option.disabled = true;
    submitSelect.add(option, 0);
    // set the selected index to the just added option:
    submitSelect.value = option.value;
    // add event listener:
    submitSelect.onchange = function(event){
        var selectElement = event.target;
        if(selectElement.value == no_value){  // first item selected (label-like), return
            return;
        }
        // create arguments for submitForm:
		var url = 'get_trellis_plots';
		var onSuccess = TRELLIS.init; //defined in trellis.js
		var onEnd = function(isError){
		    selectElement.value = no_value;
		    // set classes styling the egsim-input vue elements appearence:
		    // (`this` refers to the vue instance)
		    this.dom.visible = isError;  // this sets classes on the main div
		    if (!this.dom.modal && !isError){
			    this.dom.modal = true; // show upper div with close button
		    }
			this.dom.formclasses = isError ? [] : ['shadow', 'bg-light', 'border'];
		};
		// submit form to vuejs:
        EGSIM_INPUT.submitForm(url, onSuccess, onEnd);
    };
})()
</script>
{% endblock %}
