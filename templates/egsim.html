{% extends 'base.html' %}

{% block head %}

{% with vue=True plotly=True leaflet=True axios=True fontawesome=True %}
{{ block.super }}
{% endwith %}
<!-- for tooltips https://kazzkiq.github.io/balloon.css/ -->
<link rel="stylesheet" type='text/css' href="https://unpkg.com/balloon-css/balloon.min.css">
<!-- custom css -->
<style>
/* navbar (top toolbar with menus): */
nav .menu-item{ cursor: pointer; color: #FFF; opacity: 0.66; }
nav > .menu-item{ margin-right: 1rem; }
nav > .menu-item:first-of-type{ margin-left: 1rem}
nav .menu-item.active, nav .menu-item:hover{ opacity: 1 !important; }
#options-menu { transition: transform .25s ease-out; transform-origin: top; }
@media (max-width: 1200px){  /* narrow  screen (< 1200px) */
	nav > .menu-item span { display: none !important; } /* hide menu texts */
}
/* waitbar. For info see: https://www.pexels.com/blog/css-only-loaders/ */
#waitdiv{ z-index: 200; }
.loader, .loader:before { height: 10px; }
.loader {
	width: 100%;
	position: relative;
	overflow: hidden;
	background-color: #999;
}
.loader:before{
	display: block;
	position: absolute;
	content: "";
	left: -200px;
	width: 200px;
	background-color: #ffc107; /*#a2cd7e;*/
	animation: loading 2s linear infinite;
}
@keyframes loading {
	from {left: -200px; width: 30%;}
	50% {width: 30%;}
	70% {width: 70%;}
	80% { left: 50%;}
	95% {left: 120%;}
	to {left: 100%;}
}
/* Transitions when activating a main component: https://vuejs.org/guide/built-ins/transition.html */
.fade-enter-active, .fade-leave-active { transition: opacity .4s ease-out; }
.fade-enter, .fade-leave-to { opacity: 0; }
.error-msg {
	font-family: Lato, Helvetica, sans-serif;
	flex: 1 1 auto;
	background-color: rgba(0,0,0,0);
	color: white;
	outline: none;
	border-width: 0px;
}
</style>

{% endblock %}


{% block body %}

<div class="d-flex flex-column bg-body" id='egsim-vue' style="height: 100vh;">

	<nav class="d-flex flex-row navbar-dark bg-dark align-items-center position-relative" id='egsim-nav'>
		{% for component in components %}
			<a class='menu-item' :class="selComponent == '{{ component.0 }}' ? 'active' : ''"
					@click="setComponent('{{ component.0 }}')" title="{{ component.1 }}">
				<i class="fa {{ component.2 }}"></i> <span>{{ component.1 }}</span>
			</a>
		{% endfor %}

		<div class='invisible d-flex flex-row m-2 p-2 bg-danger text-white rounded-2 align-items-baseline'
			 style="flex: 1 1 auto" :style="{visibility: errorMsg ? 'visible !important' : 'hidden'}">
			<i class="fa fa-exclamation-circle" style="color:white"></i>&nbsp;
			<input type="text" class="error-msg " :value="errorMsg" readonly />
			<i class="fa fa-times ms-2" @click='clearErrors()' style="cursor: pointer"></i>
		</div>

		<a class="menu-item " href="#" title="options" onclick="toggleOptionsMenu(event)">
			<i class="fa fa-bars"></i>
		</a>
		<div style="transform: scaleY(0);z-index:100;" id="options-menu"
			 class="sub-menu d-flex flex-column p-2 bg-dark position-absolute end-0">
			<a class="menu-item p-2" title="API Documentation"
			   href='{{ newpage_urls.api }}' target="_blank">
				<i class="fa fa-info-circle"></i> <span>API Doc</span>
			</a>
			<a class="menu-item p-2" title="References and API License"
			   href='{{ newpage_urls.ref_and_license }}' target="_blank">
				<i class="fa fa-address-card-o"></i> <span>Ref. & License</span>
			</a>
			<a class='menu-item p-2' href='{{ newpage_urls.imprint }}' target="_blank"
			   title="Imprint">
				Imprint
			</a>
			<a class='menu-item p-2' href='{{ newpage_urls.data_protection }}' target="_blank"
			   title="Data Protection">
				Data Protection
			</a>
		</div>
	</nav>

	<div class='d-flex flex-column position-relative' style="flex: 1 1 auto">

		<div id='waitdiv' v-show='loading' class="position-absolute start-0 end-0" style='z-index:99'>
			<div class="loader"></div>
		</div>

		<div class='d-flex m-0' style="flex: 1 1 auto">
			<transition name="fade" mode="out-in">
				<keep-alive>
					<component v-bind:is="selComponent"
							   v-bind="selComponentProps"
							   :class="['home', 'apidoc'].includes(selComponent) ? 'm-0' : 'm-3 mt-4'">
					</component>
				</keep-alive>
			</transition>
			{% block main %}{% endblock %}
		</div>

	</div>
</div>

{% endblock %}

{% block after-body %}

{{ block.super }}

<script type="text/javascript">
function toggleOptionsMenu(evt){
	var elm = document.getElementById('options-menu');
	var isShowing = () => { return elm.getAttribute('data-showing') === '1' };
	function popup(visible, timeout=0){
		console.log(`skip popup ${visible} ${event.type}`);
		if (isShowing() == visible){ return; }
		console.log(`popup ${visible} ${event.type}`);
		setTimeout(() => {
			elm.style.transform = visible ? 'scaleY(1)' : 'scaleY(0)';
			elm.setAttribute('data-showing', visible ? '1': '');
		}, timeout);
	}

	if (isShowing()){
		// hide component:
		popup(false);
	}else{
		evt.stopPropagation();
		// set top (for safety) and show component
		elm.style.top = `${document.getElementById('egsim-nav').offsetHeight}px`;
		// show popup:
		popup(true);
		// add document event listener to hide popup:
		const ctr = new AbortController();
		var opts = { signal: ctr.signal };
		document.addEventListener('click', e => { popup(false, 100); ctr.abort();}, opts);
		document.addEventListener('keydown', e => { console.log(e.keyCode); if(e.keyCode != 9){popup(false, 100); ctr.abort();} }, opts);
	}
};

function getBrowser() {
	// Return the Array [browser, version] e.g. (examples tested locally):
	// ["Firefox", 97], ["Chrome": 97], ["Safari", 15]. The version might be NaN.
	// This code uses heuristics and should be used to display information only
	// (https://stackoverflow.com/a/16938481)

	var ua=navigator.userAgent;
	var tem;
	var M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
	if(/trident/i.test(M[1])){
		tem=/\brv[ :]+(\d+)/g.exec(ua) || [];
		return ['IE', parseInt(tem[1])];
	}
	if(M[1]==='Chrome'){
		tem=ua.match(/\bOPR|Edge\/(\d+)/)
		if(tem!=null){
			return ['Opera', parseInt(tem[1])];
		}
	}
	M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
	if((tem=ua.match(/version\/(\d+)/i))!=null){
		M.splice(1,1,tem[1]);
	}
	return [M[0], parseInt(M[1])];
};
function unsupportedBrowserMessage(){
	try {
		var [name, version] = getBrowser();
		var minVersion = {{ allowed_browsers | safe }}[name.toLowerCase()];
		if (!minVersion || isNaN(version) || minVersion > version){
			return "{{ invalid_browser_message | safe }}";
		}
	} catch (error) {
		// avoid breaking the program in case of bug
		console.log("Warning: unable to check browser compatibility");
	}
	return "";
};
</script>

<!-- VUE.JS: -->

<script type='text/javascript' src = "{% static 'js/egsim_base.js' %}"></script>
<script>
/* Init the EGSIM Vue Instance with content injected from the server */
var EGSIM = Vue.createApp({
	mixins: [EGSIM_BASE],  /* defined in egsim_base.js */
	data: function(){
		return {
			gsims: Vue.markRaw({{ gsims|safe }}),
			imtGroups: Vue.markRaw({{ imt_groups|safe }}),
			selComponent: "{{sel_component}}",
			flatfileUploadUrl: "{{flatfile_upload_url}}",
			regionalization: Vue.markRaw({{ regionalization|safe }}),
			initialErrorMsg: unsupportedBrowserMessage(),
			componentProps: {{ component_props | safe }}
		};
	}
});

/** setup a global HTTPClient to issue post requests */
EGSIM.config.globalProperties.$httpClient = new HTTPClient(Object.freeze({headers: {"X-CSRFToken": "{{ csrf_token }}"}}));

/* setup the global Array of flatfiles, accessible anywhere as `this.$flatfiles` */
EGSIM.config.globalProperties.$flatfiles = Vue.reactive({{flatfiles|safe}});
</script>

<!-- Components and dependencies of the EGISM app: -->
<script type='text/javascript' src="{% static 'js/v-components/base/field-input.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/gsim-select.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/egsim-form.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/plots-div.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}flatfile.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}trellis.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}residuals.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}testing.js"></script>
<script>
/* Register simple Vue component here to speed up rendering: */
EGSIM.component('home', {
	props: {src: String},
	template: `<iframe style='flex: 1 1 auto' :src='src'></iframe>`
});

/* mount app, and set the mounted instance as only listener for our httpClient: */
EGSIM.config.globalProperties.$httpClient.listeners = [EGSIM.mount('#egsim-vue')];
</script>

{% endblock %}
