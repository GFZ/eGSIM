{% extends 'base.html' %}

{% block head %}

{% with vue=True plotly=True leaflet=True axios=True fontawesome=True %}
{{ block.super }}
{% endwith %}
<!-- includes css for form-related stuff (e.g. waitbar)  -->
<link rel="stylesheet" type="text/css" href="{% static 'css/egsim.css' %}">
<!-- for tooltips https://kazzkiq.github.io/balloon.css/ -->
{% if debug %}
<link rel='stylesheet' type='text/css' href='/static/fallbacks/balloon.1.0.3.css'/>
{% else %}
<link rel="stylesheet" type='text/css' href="https://unpkg.com/balloon-css/balloon.min.css">
{% endif %}

{% endblock %}


{% block body %}
	<div class="d-flex flex-column height100 bg-light" id='egsim-vue'>

		<nav class="d-flex flex-row navbar-dark bg-dark align-items-stretch position-relative" id='egsim-nav'>
				{% for component in components %}
					<a class='menu-item' :class="selComponent == '{{ component.0 }}' ? 'active' : ''"
							@click="setComponent('{{ component.0 }}')" title="{{ component.1 }}">
						<i class="fa {{ component.2 }}"></i> <span>{{ component.1 }}</span>
					</a>
				{% endfor %}

				<div class='d-flex flex-row m-2 p-2 bg-danger text-white rounded-2 align-items-baseline'
					 style="flex: 1 1 auto" :style="{visibility: errorMsg ? 'visible' : 'hidden'}">
					<input type="text" class="border-0" :value="errorMsg"
						   style="flex: 1 1 auto; background-color: rgba(0,0,0,0); color: white;outline: none;" readonly />
					<!--<i class="fa fa-copy ms-1" @click=''></i>-->
					<i class="fa fa-times ms-2" @click='clearErrors()' style="cursor: pointer"></i>
				</div>

				<a class="menu-item " href="#" title="options"
				   onclick="this.nextElementSibling.style.transform ? this.nextElementSibling.style.removeProperty('transform') : this.nextElementSibling.style.transform='scaleY(0)'">
					<i class="fa fa-bars"></i>
				</a>
				<div style="transform: scaleY(0);z-index:100" class="sub-menu d-flex flex-column p-2 bg-dark position-absolute end-0">
					<a class="menu-item py-2" title="API Doc / Legal Info" href='{{ newpage_urls.api }}' target="_blank">
						<i class="fa fa-info-circle"></i> <span>API Doc</span>
					</a>
					<a class="menu-item py-2" title="References and License Info" href='{{ newpage_urls.ref_and_license }}' target="_blank">
						<i class="fa fa-address-card-o"></i> <span>Ref. & License</span>
					</a>
					<a class='menu-item py-2' href='{{ newpage_urls.imprint }}' target="_blank" title="Imprint"
					   onclick="this.parentNode.style.transform='scaleY(0)'">
						Imprint
					</a>
					<a class='menu-item py-2' href='{{ newpage_urls.data_protection }}' target="_blank" title="Data Protection"
					   onclick="this.parentNode.style.transform='scaleY(0)'">
						Data Protection
					</a>
				</div>
		</nav>

		<div class='d-flex flex-column position-relative' style="flex: 1 1 auto">

			<div id='waitdiv' v-show='loading' class="position-absolute start-0 end-0" style='z-index:99'>
				<div class="loader"></div>
			</div>

			<div class='d-flex m-0' style="flex: 1 1 auto">
				<transition name="fade" mode="out-in">
					<keep-alive>
						<component v-bind:is="selComponent"
								   v-bind="selComponentProps"
								   :class="['home', 'apidoc'].includes(selComponent) ? 'm-0' : 'm-3 mt-4'">
						</component>
					</keep-alive>
				</transition>
				{% block main %}{% endblock %}
			</div>

		</div>
	</div>

{% endblock %}

{% block after-body %}

{{ block.super }}

<script type="text/javascript">
/**
 * Before initializing all Vue stuff, check browser compatibility and, if needed,
 * create global var message that will be passed to the Vue instance
 */
function getBrowser() {
	// Return the Array [browser, version] e.g. (examples tested locally):
	// ["Firefox", 97], ["Chrome": 97], ["Safari", 15]. The version might be NaN.
	// This code uses heuristics and should be used to display information only
	// (https://stackoverflow.com/a/16938481)

	var ua=navigator.userAgent;
	var tem;
	var M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
	if(/trident/i.test(M[1])){
		tem=/\brv[ :]+(\d+)/g.exec(ua) || [];
		return ['IE', parseInt(tem[1])];
	}
	if(M[1]==='Chrome'){
		tem=ua.match(/\bOPR|Edge\/(\d+)/)
		if(tem!=null){
			return ['Opera', parseInt(tem[1])];
		}
	}
	M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
	if((tem=ua.match(/version\/(\d+)/i))!=null){
		M.splice(1,1,tem[1]);
	}
	return [M[0], parseInt(M[1])];
};
var _UNSUPPORTED_BROWSER_MSG = function(){
	try {
		var [name, version] = getBrowser();
		var minVersion = {{ allowed_browsers | safe }}[name.toLowerCase()];
		if (!minVersion || isNaN(version) || minVersion > version){
			return "{{ invalid_browser_message | safe }}";
		}
	} catch (error) {
		// avoid breaking the program in case of bug
		console.log("Warning: unable to check browser compatibility");
	}
	return "";
}();
</script>

<!-- VUE.JS: -->

<script type='text/javascript' src = "{% static 'js/egsim_base.js' %}"></script>
<script>
/**
 * Init the EGSIM Vue Instance with content injected from the server and the
 * the browser version check just implemented
*/
var EGSIM = Vue.createApp({
	mixins: [EGSIM_BASE],  /* defined in egsim_base.js */
	data: function(){
		return {
			gsims: {{ gsims|safe }},
			// default config for the POST function:
			// (csrf token stored in an <input> in the base.html. Get it here and use it for each post request):
			postfuncDefaultConfig: Object.freeze({headers: {"X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value}}),
			selComponent: "{{sel_component}}",
			// flatfiles: {{flatfiles|safe}},
			flatfileUploadUrl: "{{flatfile_upload_url}}",
			regionalization: {{ regionalization|safe }},
			// incompatibleBrowserMessage is defined in browserdetection.js:
			initialErrorMsg: _UNSUPPORTED_BROWSER_MSG,
			componentProps: {{ component_props | safe }}
		};
	}
});
// provide the Array of flatfiles as global variable `$flatfiles`, and make it
// reactive as it must be updated with whatever file is uploaded by the user
EGSIM.config.globalProperties.$flatfiles = Vue.reactive({{flatfiles|safe}});
</script>

<!-- Components and dependencies of the EGISM app: -->
<script type='text/javascript' src="{% static 'js/v-components/base/field-input.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/gsim-select.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/egsim-form.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/plot-div.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}flatfile.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}trellis.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}residuals.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}testing.js"></script>
<script>
/**
 * Registers globally "apidoc" and "home" Vue components here in order to avoid further
 * JS requests for just few lines of code. Remember, the component names must be a name
 * of a TAB Enum in egsim.gui.__init__.py
 */
EGSIM.component('home', {
	props: {src: String},
	template: `<iframe style='flex: 1 1 auto' :src='src'></iframe>`
});

const EGSIM_APP = EGSIM;
EGSIM = EGSIM_APP.mount('#egsim-vue');

</script>

{% endblock %}
