{% extends 'base.html' %}

{% block head %}
	{% with vue=True plotly=True leaflet=True axios=True fontawesome=True %}
		{{ block.super }}
	{% endwith %}
	<!-- includes css for form-related stuff (e.g. waitbar)  -->
	<link rel="stylesheet" type="text/css" href="{% static 'css/egsim.css' %}">
	<!-- for tooltips https://kazzkiq.github.io/balloon.css/ -->
	{% if debug %}
	<link rel='stylesheet' type='text/css' href='/static/fallbacks/balloon.1.0.3.css'/>
	{% else %}
	<link rel="stylesheet" type='text/css' href="https://unpkg.com/balloon-css/balloon.min.css">
	{% endif %}
{% endblock %}

{% block body %}
	<div class="d-flex flex-column height100" id='egsim-vue'>

		<nav class="d-flex flex-row navbar-dark bg-dark align-items-center" id='egsim-nav'>
				{% for component in components %}
					{% if forloop.last %}
						<div class='flexible'></div>
					{% endif %}
					<a class='menu-item' :class="selComponent == '{{ component.0 }}' ? 'active' : ''"
							@click="setComponent('{{ component.0 }}')" title="{{ component.1 }}">
						<i class="fa {{ component.2 }}"></i> <span>{{ component.1 }}</span>
					</a>
				{% endfor %}
				<!-- imprint adn data protection: -->
				<table style='font-size:small'>
					<tr><td>
						<a style='padding-top:0;padding-bottom:0' class='menu-item'
							href='/imprint' target="_blank"
							 title="imprint">
							Imprint
						</a>
					</td></tr>
					<tr><td>
						<a style='padding-top:0;padding-bottom:0' class='menu-item'
							href='{{ data_protection_url }}'
							target="_blank" title="Data Protection">
							Data Protection
						</a>
					</td></tr>
				</table>
		</nav>

		<div class='flexible d-flex flex-column position-relative'>

			<div id='waitdiv' v-show='loading' class="position-absolute pos-t-0 pos-x-0" style='z-index:99'>
				<!-- Loading, please wait ... --> <!-- (<- text removed) -->
				<div class="loader"></div>
			</div>
	
			<div v-show='errormsg'
				class='d-flex flex-row bg-danger text-sm-center text-white text-truncate position-absolute pos-t-0 pos-x-0 align-items-baseline'
				style='z-index:100'>
				<div class='flexible ml-1' v-html='errormsg' id='globalerrormessage-div'>
					{{ invalid_browser_message | safe }}
				</div>
				<i class="fa fa-times mr-1" @click='clearErrors()'></i>
			</div>
			
			<div class='d-flex flexible m-0'>
				<transition name="fade" mode="out-in">
				<keep-alive>
					<!-- https://vuejs.org/v2/guide/components-dynamic-async.html#keep-alive-with-Dynamic-Components -->
					<!-- Further note on "@emit-event='handleEmittedEvent'": the line binds
					components firing `$emit('emit-event', eventName, ...)` to the function
					`handleEmittedEvent` on the main instance (implemented in egsim_base.js)  -->
					<component v-bind:is="selComponent"
						v-bind="selComponentProps"
						@emit-event='handleEmittedEvent'
						:class="['home', 'apidoc'].includes(selComponent) ? 'm-0' : 'm-3 mt-4'"
					></component>
				</keep-alive>
				</transition>
				{% block main %}{% endblock %}
			</div>

		</div>
	</div>

{% endblock %}

{% block after-body %}
	{{ block.super }}

	<script>
	/**
	 * Before initializing all Vue stuff, check browser compatibility and, in negative case,
	 * create global var message that will be passed to the Vue instance
	 */
	function getBrowser() {
		// Return the Array [browser, version] e.g. (examples tested locally):
		// ["Firefox", 97], ["Chrome": 97], ["Safari", 15]. The version might be NaN.
		// This code uses heuristics and should be used to display information only
		// (https://stackoverflow.com/a/16938481)

		var ua=navigator.userAgent;
		var tem;
		var M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
		if(/trident/i.test(M[1])){
			tem=/\brv[ :]+(\d+)/g.exec(ua) || [];
			return ['IE', parseInt(tem[1])];
		}
		if(M[1]==='Chrome'){
			tem=ua.match(/\bOPR|Edge\/(\d+)/)
			if(tem!=null){
				return ['Opera', parseInt(tem[1])];
			}
		}
		M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
		if((tem=ua.match(/version\/(\d+)/i))!=null){
			M.splice(1,1,tem[1]);
		}
		return [M[0], parseInt(M[1])];
	};
	var _UNSUPPORTED_BROWSER_MSG = function(){
		try {
			var [name, version] = getBrowser();
			var minVersion = {{ allowed_browsers | safe }}[name.toLowerCase()];
			if (!minVersion || isNaN(version) || minVersion > version){
				return "{{ invalid_browser_message | safe }}";
			}
		} catch (error) {
			// avoid breaking the program in case of bug
			console.log("Warning: unable to check browser compatibility");
		}
		return "";
	}();
	</script>


	<!-- VueJS stuff -->
	<script type='text/javascript' src = "{% static 'js/v-components/base/field-input.js' %}"></script>
	<script type='text/javascript' src = "{% static 'js/v-components/base/gsim-select.js' %}"></script>
	<script type='text/javascript' src = "{% static 'js/v-components/base/plot-div.js' %}"></script>
	<script type='text/javascript' src = "{% static 'js/v-components/base/download-select.js' %}"></script>
	<script type='text/javascript' src = "{% static 'js/v-components/base/base-form.js' %}"></script>
	<script type='text/javascript' src = "{% static 'js/v-components/' %}trellis.js"></script>
	<script type='text/javascript' src = "{% static 'js/v-components/' %}residuals.js"></script>
	<script type='text/javascript' src = "{% static 'js/v-components/' %}testing.js"></script>
	<script>
	/**
	 * Registers globally "apidoc" and "home" Vue components here in order to avoid further JS
	 * requests for just few lines of code. Remember, the component names must be a name of a TAB
	 * Enum in egsim.gui.__init__.py
	 */
	Vue.component('home', {
		props: {src: String},
		template: `<iframe class='flexible' :src='src'></iframe>`
	});
	Vue.component('apidoc', {
		props: {
			src: String,
			id: {String, default: '__apidoc__iframe__'},
			fragment: {String, default: ''}
		},
		template: `<iframe :id='id' class='flexible' :src='src + fragment'></iframe>`
	});
	</script>
	<script type='text/javascript' src = "{% static 'js/egsim_base.js' %}"></script>
	<script>
	/**
	 * Init the EGSIM Vue Instance with content injected from the server and the
	 * browser version check just implemented
	*/
	var EGSIM = new Vue({
		el: '#egsim-vue',
		mixins: [EGSIM_BASE],  /* defined in egsim_base.js */
		data: function(){
			return {
				gsims: {{ gsims|safe }},
				// default config for the POST function:
				// (csrf token stored in an <input> in the base.html. Get it here and use it for each post request):
				postfuncDefaultConfig: Object.freeze({headers: {"X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value}}),
				selComponent: "{{sel_component}}",
				regionalization: {{ regionalization|safe }},
				// incompatibleBrowserMessage is defined in browserdetection.js:
				errormsg: _UNSUPPORTED_BROWSER_MSG,
				componentProps: {{ component_props | safe }}
			};
		}
	});
	</script>
{% endblock %}
