{% extends 'base.html' %}

{% block head %}

{% with vue=True plotly=True leaflet=True axios=True fontawesome=True %}
{{ block.super }}
{% endwith %}
<!-- custom css -->
<style>
@media (max-width: 975px){  /* narrow  screen (< 975px) */
	nav > .menu-item span { display: none !important; } /* hide menu texts */
}
/* waitbar. For info see: https://www.pexels.com/blog/css-only-loaders/ */
.loader, .loader:before { height: 10px; }
.loader {
	width: 100%;
	position: relative;
	overflow: hidden;
	background-color: #999;
}
.loader:before{
	display: block;
	position: absolute;
	content: "";
	left: -200px;
	width: 200px;
	background-color: #ffc107; /*#a2cd7e;*/
	animation: loading 2s linear infinite;
}
@keyframes loading {
	from {left: -200px; width: 30%;}
	50% {width: 30%;}
	70% {width: 70%;}
	80% { left: 50%;}
	95% {left: 120%;}
	to {left: 100%;}
}
/* Transitions when activating a main component: https://vuejs.org/guide/built-ins/transition.html */
.fade-enter-active, .fade-leave-active { transition: opacity .4s ease-out; }
.fade-enter, .fade-leave-to { opacity: 0; }
</style>

{% endblock %}


{% block body %}

<div class="d-flex flex-column bg-body" id='egsim-vue' style="height: 100vh;"></div>

<div id='tooltip' style="display:inline-block; position:fixed; overflow:auto; z-index:100000; transform:scaleY(0); transition:transform .25s ease-out;"
	 class="shadow p-2 bg-dark bg-gradient text-white"></div>

{% endblock %}

{% block after-body %}

{{ block.super }}

<script>
axios.interceptors.request.use(function (config) {
	if (!('headers' in config)){
		config.headers = {};
	}
	config.headers["X-CSRFToken"] = "{{ csrf_token }}";
	return config;
});
</script>

<!-- VUE.JS: -->
<script type='text/javascript' src = "{% static 'js/egsim.js' %}"></script>
<!-- Components and dependencies of the EGISM app: -->
<script type='text/javascript' src="{% static 'js/v-components/base/field-input.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/gsim-select.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/egsim-form.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/plots-div.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}flatfile.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}trellis.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}residuals.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}testing.js"></script>
<script>
/* mount the Vue App EGSIM. The function below returns an App instance (not used for the moment): */
EGSIM.mount('#egsim-vue');
</script>


<script type='text/javascript'>
// tooltips: replace all elements aria-label with an event listener that displays the aria-label text in a tooltip on hover
// use a MutationObserver (see below) as the listeners should be dynamically added/removed when any document element is changed
const tooltipManager = {
	showTooltip(evt){
		// console.log('element.mouseenter.started');
		var target = evt.target;
		var tooltipContent = target.getAttribute && target.getAttribute('aria-label') + "";
		if(!tooltipContent){ return; }  // for safety
		var tooltip = document.getElementById('tooltip');
		tooltip.innerHTML = tooltipContent + "";
		// position tooltip:
		var rect = target.getBoundingClientRect();
		// define tooltip vertical dimensions (max-height, top, bottom):
		var TOOLTIP_MIN_H = .25;  // tooltip max height (relative to the viewport height)
		tooltip.style.maxHeight = `${parseInt(TOOLTIP_MIN_H*100)}vh`;
		var winH = window.innerHeight;  // window (viewport) height
		if ((winH - rect.bottom) / winH <= TOOLTIP_MIN_H){  // place tooltip below
			tooltip.style.top = '';
			tooltip.style.bottom = `${winH - rect.top}px`;
		}else{  // place tooltip above
			tooltip.style.top = `${rect.bottom}px`;
			tooltip.style.bottom = '';
		}
		// define tooltip horizontal dimensions (max-width, left, right):
		var TOOLTIP_MIN_W = .25; // tooltip max width (relative to the viewport width)
		tooltip.style.maxWidth = `${parseInt(TOOLTIP_MIN_W*100)}vw`;
		var winW = window.innerWidth;  // window (viewport) height
		if ((winW - rect.right) / winW < TOOLTIP_MIN_W/2){  // align tooltip and target right sides
			tooltip.style.left = '';
			tooltip.style.right = `${winW - rect.right}px`;
		}else{  // align tooltip and target left sides
			tooltip.style.left = `${rect.x}px`;
			tooltip.style.right = '';
		}
		tooltip.style.transform = 'scaleY(1)';
		// for safety, stop propagation:
		evt.stopPropagation();
		// console.log(`width: ${tooltip.clientWidth}, cssWidth: ${getComputedStyle(tooltip).getPropertyValue('width')}`);
	},
	hideTooltip(evt){ document.getElementById('tooltip').style.transform='scaleY(0)'; }
};

new MutationObserver((mutations) => {
	for (let mutation of mutations) {
		var target = mutation.target;
		var nodes = [];
		if (mutation.type == 'childList'){
			nodes = target.querySelectorAll('[aria-label], [data-tooltip-text]');
		}else if (mutation.type == 'attributes' && mutation.attributeName == 'aria-label') {
			nodes = [target];
		}
		for (var node of nodes){
			var tooltip = node.getAttribute('aria-label') || "";
			var tooltipRemainder = node.getAttribute('data-tooltip-text') || "";
			// tooltip empty / missing => remove event listener if tooltipReminder not empty
			// tooltip not empty / missing => add event listener if tooltipReminder
			if (!tooltip && tooltipRemainder) {
				node.removeAttribute('data-tooltip-text');
				node.removeEventListener('mouseenter', tooltipManager.showTooltip);
				node.removeEventListener('mousedown', tooltipManager.hideTooltip);
				node.removeEventListener('mouseleave', tooltipManager.hideTooltip);
			}else if (tooltip && tooltip != tooltipRemainder){
				node.setAttribute('data-tooltip-text', tooltip);
				node.addEventListener('mouseenter', tooltipManager.showTooltip);
				node.addEventListener('mousedown', tooltipManager.hideTooltip);
				node.addEventListener('mouseleave', tooltipManager.hideTooltip);
			}
		}
	}
}).observe(document.getElementById('egsim-vue'), {
	childList: true,
	attributes: true,
	subtree: true,
});
</script>
{% endblock %}
