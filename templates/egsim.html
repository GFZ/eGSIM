{% extends 'base.html' %}

{% block head %}

{% with vue=True plotly=True leaflet=True axios=True fontawesome=True %}
{{ block.super }}
{% endwith %}
<!-- for tooltips https://kazzkiq.github.io/balloon.css/ -->
<link rel="stylesheet" type='text/css' href="https://unpkg.com/balloon-css/balloon.min.css">
<!-- custom css -->
<style>
/* navbar (top toolbar with menus): */
nav .menu-item{ cursor: pointer; color: #FFF; opacity: 0.66; }
nav > .menu-item{ margin-right: 1rem; }
nav > .menu-item:first-of-type{ margin-left: 1rem}
nav .menu-item.active, nav .menu-item:hover{ opacity: 1 !important; }
#options-menu { transition: transform .25s ease-out; transform-origin: top; }
@media (max-width: 1200px){  /* narrow  screen (< 1200px) */
	nav > .menu-item span { display: none !important; } /* hide menu texts */
}
/* waitbar. For info see: https://www.pexels.com/blog/css-only-loaders/ */
#waitdiv{ z-index: 200; }
.loader, .loader:before { height: 10px; }
.loader {
	width: 100%;
	position: relative;
	overflow: hidden;
	background-color: #999;
}
.loader:before{
	display: block;
	position: absolute;
	content: "";
	left: -200px;
	width: 200px;
	background-color: #ffc107; /*#a2cd7e;*/
	animation: loading 2s linear infinite;
}
@keyframes loading {
	from {left: -200px; width: 30%;}
	50% {width: 30%;}
	70% {width: 70%;}
	80% { left: 50%;}
	95% {left: 120%;}
	to {left: 100%;}
}
/* Transitions when activating a main component: https://vuejs.org/guide/built-ins/transition.html */
.fade-enter-active, .fade-leave-active { transition: opacity .4s ease-out; }
.fade-enter, .fade-leave-to { opacity: 0; }
.error-msg {
	font-family: Lato, Helvetica, sans-serif;
	flex: 1 1 auto;
	background-color: rgba(0,0,0,0);
	color: white;
	outline: none;
	border-width: 0px;
}
</style>

{% endblock %}


{% block body %}

<div class="d-flex flex-column bg-body" id='egsim-vue' style="height: 100vh;"></div>

{% endblock %}

{% block after-body %}

{{ block.super }}

<script type="text/javascript">
function toggleOptionsMenu(evt){
	var elm = document.getElementById('options-menu');
	var isShowing = () => { return elm.getAttribute('data-showing') === '1' };
	function popup(visible, timeout=0){
		console.log(`skip popup ${visible} ${event.type}`);
		if (isShowing() == visible){ return; }
		console.log(`popup ${visible} ${event.type}`);
		setTimeout(() => {
			elm.style.transform = visible ? 'scaleY(1)' : 'scaleY(0)';
			elm.setAttribute('data-showing', visible ? '1': '');
		}, timeout);
	}

	if (isShowing()){
		// hide component:
		popup(false);
	}else{
		evt.stopPropagation();
		// set top (for safety) and show component
		elm.style.top = `${document.getElementById('egsim-nav').offsetHeight}px`;
		// show popup:
		popup(true);
		// add document event listener to hide popup:
		const ctr = new AbortController();
		var opts = { signal: ctr.signal };
		document.addEventListener('click', e => { popup(false, 100); ctr.abort();}, opts);
		document.addEventListener('keydown', e => { console.log(e.keyCode); if(e.keyCode != 9){popup(false, 100); ctr.abort();} }, opts);
	}
};
/*
function unsupportedBrowserMessage(){
	try {
		var [name, version] = getBrowser();
		var minVersion = {{ allowed_browsers | safe }}[name.toLowerCase()];
		if (!minVersion || isNaN(version) || minVersion > version){
			return "{{ invalid_browser_message | safe }}";
		}
	} catch (error) {
		// avoid breaking the program in case of bug
		console.log("Warning: unable to check browser compatibility");
	}
	return "";
};
*/
</script>

<!-- VUE.JS: -->

<script type='text/javascript' src = "{% static 'js/egsim_base.js' %}"></script>
<script>
/* Init the EGSIM Vue Instance with content injected from the server */
/*
const EGSIM = Vue.createApp({
	mixins: [EGSIM_BASE],  // defined in egsim_base.js
	data: function(){
		return {
			gsims: [],
			imtGroups: Vue.markRaw({{ imt_groups|safe }}),
			selComponent: "{{sel_component}}",
			flatfileUploadUrl: "{{flatfile_upload_url}}",
			regionalization: Vue.markRaw({{ regionalization|safe }}),
			initialErrorMsg: unsupportedBrowserMessage(),
			componentProps: {}
		};
	}
});
*/

/* setup the global Array of flatfiles, accessible anywhere as `this.$flatfiles` */
/* EGSIM.config.globalProperties.$flatfiles = Vue.reactive({{flatfiles|safe}}); */

axios.interceptors.request.use(function (config) {
	if (!('headers' in config)){
		config.headers = {};
	}
	config.headers["X-CSRFToken"] = "{{ csrf_token }}";
	return config;
});
</script>

<!-- Components and dependencies of the EGISM app: -->
<script type='text/javascript' src="{% static 'js/v-components/base/field-input.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/gsim-select.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/egsim-form.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/base/plots-div.js' %}"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}flatfile.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}trellis.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}residuals.js"></script>
<script type='text/javascript' src="{% static 'js/v-components/' %}testing.js"></script>
<script>
/* mount app and return an App instance (eGSIM): */
const eGSIM = EGSIM.mount('#egsim-vue');
</script>

{% endblock %}
